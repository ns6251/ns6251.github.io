<!doctype html><html lang=en data-mode=light><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world"><title>PhantomData&lt;T>とtrait境界</title><meta name=author content="ns6251"><meta name=robots content="index follow"><link rel=canonical href=https://ns6251.github.io/posts/phantomdata-trait-bound/><meta property="og:site_name" content="ns6251のブログ"><meta property="og:title" content="PhantomDataとtrait境界"><meta property="og:url" content="https://ns6251.github.io/posts/phantomdata-trait-bound/"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-05-15"><meta property="article:modified_time" content="2022-05-15"><meta property="og:updated_time" content="2022-05-15"><meta name=twitter:creator content="@ns6251"><meta name=twitter:site content="@ns6251"><meta name=theme-color content="#222"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"https:\/\/ns6251.github.io\/"},"headline":"PhantomData\u003cT\u003eとtrait境界","description":"","url":"https:\/\/ns6251.github.io\/posts\/phantomdata-trait-bound\/","inLanguage":"en","datePublished":"2022-05-15","dateModified":"2022-05-15","wordCount":"255","publisher":{"@type":"Person","name":"ns6251"},"author":{"@type":"Person","name":"ns6251","description":"🦀❤","sameAs":["https://github.com/ns6251","https://qiita.com/ns6251","https://twitter.com/ns6251"]}}</script><link rel=stylesheet href=https://ns6251.github.io/css/main.min.1b397ce64f949bf1c8ebbbaebab50c4d68060e934f84b36d4e4af4b516c1f0d0.css integrity="sha256-Gzl85k+Um/HI67uuurUMTWgGDpNPhLNtTkr0tRbB8NA=" crossorigin=anonymous><noscript><meta name=theme-color content="#1dbc91" media="(prefers-color-scheme: dark)"><meta name=theme-color content="#1f676b" media="(prefers-color-scheme: light)"><link rel=stylesheet href=https://ns6251.github.io/css/noscript.min.9bacd85b6f1d42296c56d3b8457d0c13a4e7f415c4ca5fc8affb6ed6b39cad72.css integrity="sha256-m6zYW28dQilsVtO4RX0ME6Tn9BXEyl/Ir/tu1rOcrXI=" crossorigin=anonymous></noscript><link rel=preload href=/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous><link rel=me href=https://github.com/ns6251><link rel=me href=https://qiita.com/ns6251><link rel=me href=https://twitter.com/ns6251><script src=https://ns6251.github.io/js/main.f1da21dfea83dc0c36cea0b202c14a97e00aedab567e32702eb120f5ab8d974b.js integrity="sha256-8doh3+qD3Aw2zqCyAsFKl+AK7atWfjJwLrEg9auNl0s=" crossorigin=anonymous></script></head><body><header><a href=/>ns6251のブログ</a><nav aria-label="Main menu."><ul><li><a class=btn href=/about/>About</a></li><li><a class=btn href=/posts/>Posts</a></li></ul></nav></header><div class=filler><main><article><header><h1>PhantomData<t>とtrait境界</h1><p>Published on <time datetime=2022-05-15>2022-05-15</time></p></header><p>いつもだったらTwitterで「にゃーん」といっておしまいにしてしまう些細な引っ掛かりを，敢えて書き起こしてみる．</p><h2 id=tldr><a class=anchor href=#tldr title="Anchor for: TL:DR."><svg aria-hidden="true"><use xlink:href="/img/bundle.min.400384900ca9c1c2b3d867283b9f34c2.svg#hashtag"/></svg></a>TL:DR</h2><p><code>PhantomData&lt;T></code>の<code>T</code>のtrait境界のせいで実装した（と思った）<code>Clone</code>, <code>Copy</code>がはがされて悲しかった😢という話．</p><p><a href="https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=24830c5237335c4e896c747592892413">playgroundのサンプルコード</a>．</p><h2 id=導入><a class=anchor href=#導入 title="Anchor for: 導入."><svg aria-hidden="true"><use xlink:href="/img/bundle.min.400384900ca9c1c2b3d867283b9f34c2.svg#hashtag"/></svg></a>導入</h2><p>例えば，様々なエンティティのIDとなる型をジェネリクスを使って定義したとする．
<code>PhantomData</code>はその名の通り実態のない型である．（<a href=https://doc.rust-jp.rs/rust-by-example-ja/generics/phantom.html>Rust By Example参照</a>）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug, Clone, Copy, PertialEq, Eq, Ord, PertialOrd, Hash)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Id</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    id: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    _marker: <span style=color:#a6e22e>PhantomData</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>User</code>というエンティティの場合，以下のように<code>Id</code>を利用する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>User</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> id: <span style=color:#a6e22e>Id</span><span style=color:#f92672>&lt;</span>Self<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> name: String,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>このイディオム？を利用すると大量の<code>SomeEntityId</code>みたいなstructの定義をサボることができる．</p><h2 id=悲しかったこと><a class=anchor href=#悲しかったこと title="Anchor for: 悲しかったこと."><svg aria-hidden="true"><use xlink:href="/img/bundle.min.400384900ca9c1c2b3d867283b9f34c2.svg#hashtag"/></svg></a>悲しかったこと</h2><p>これが出来ない．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> user <span style=color:#f92672>=</span> User::new();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> user_id <span style=color:#f92672>=</span> user.id.clone();
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;{:?}, {:?}&#34;</span>, user, user_id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>こんなエラーを吐く．</p><pre aria-label="Box containing code sample." tabindex=0><code>error[E0599]: the method `clone` exists for struct `Id&lt;User&gt;`, but its trait bounds were not satisfied
  --&gt; src/main.rs:39:27
   |
6  | pub struct Id&lt;T&gt; {
   | ----------------
   | |
   | method `clone` not found for this
   | doesn&#39;t satisfy `Id&lt;User&gt;: Clone`
...
21 | pub struct User {
   | --------------- doesn&#39;t satisfy `User: Clone`
...
39 |     let user_id = user.id.clone();
   |                           ^^^^^ method cannot be called on `Id&lt;User&gt;` due to unsatisfied trait bounds
   |
note: the following trait bounds were not satisfied because of the requirements of the implementation of `Clone` for `_`:
      `User: Clone`
  --&gt; src/main.rs:5:17
   |
5  | #[derive(Debug, Clone, Copy, PartialEq, Eq, Ord, PartialOrd, Hash)]
   |                 ^^^^^
   = help: items from traits can only be used if the trait is implemented and in scope
   = note: the following trait defines an item `clone`, perhaps you need to implement it:
           candidate #1: `Clone`
   = note: this error originates in the derive macro `Clone` (in Nightly builds, run with -Z macro-backtrace for more info)
help: consider annotating `User` with `#[derive(Clone)]`
   |
21 | #[derive(Clone)]
   |
</code></pre><p>要は，<code>Id&lt;T></code>には<code>Clone</code>が実装されているが，<code>User</code>には<code>Clone</code>が実装されていないため，<code>Id&lt;User></code>では，
<code>Clone</code>がはがされて？怒られている．（これは<code>Copy</code>や，そのたderiveしたはずのtraitでも同様である．）</p><p>つまり，<code>Id&lt;User></code>の中の，<code>_marker: PhantomData&lt;User></code>に<code>Clone</code>が実装されていないことが問題となっている<sup id=fnref:1><a href=#fn:1 class=footnote-ref title="See footnotes." role=doc-noteref>1</a></sup>．
しかし，PhantomDataは実態のない型であって，実際のところ <code>id: u32</code>が<code>Clone</code>できるのだから，<code>Clone</code>出来てしまって欲しかった😢
（これが出来てしまったらそれはそれで問題な気もするが，どう問題になるのかまでは考えていない）</p><h2 id=おわりに><a class=anchor href=#おわりに title="Anchor for: おわりに."><svg aria-hidden="true"><use xlink:href="/img/bundle.min.400384900ca9c1c2b3d867283b9f34c2.svg#hashtag"/></svg></a>おわりに</h2><p>というわけで，このケースで<code>Clone</code>する裏ワザがあったら教えてください (<code>Id&lt;T></code>をやめる，<code>impl Clone for User</code>，<code>impl Clone for Id&lt;User></code>を除く)．</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>このサンプルでは，<code>User</code>に<code>Clone</code>を実装すれば解決するが，<code>User</code>のフィールドに <code>Clone</code>できないものがある場合など，<code>User</code>に<code>Clone</code>を実装できない場合も考えられる．&#160;<a href=#fnref:1 class=footnote-backref title="Return to text." role=doc-backlink>Return</a></p></li></ol></div></article></main></div><footer><section class=req-js><button class=outline-dashed title="Change to light/dark mode."><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><use xlink:href="/img/bundle.min.400384900ca9c1c2b3d867283b9f34c2.svg#adjust"/></svg></button><input class=outline-dashed type=color list=presets value=#1f676b title="Change accent color." aria-label="Change accent color."><datalist id=presets><option value=#1f676b><option value=#1dbc91></datalist></section></footer></body></html>